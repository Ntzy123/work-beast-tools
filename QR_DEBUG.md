# 二维码生成问题调试指南

## 问题现状

APK 打包后安装在手机上，无法查看控制台日志，导致二维码生成失败时无法定位问题。

## 解决方案

已添加**可视化调试信息**功能，可以在手机界面上直接查看详细的生成过程和错误信息。

---

## 使用方法

### 1. 生成水印

1. 选择图片
2. 输入姓名
3. 设置时间
4. 点击"生成水印"

### 2. 查看调试信息

生成完成后，在生成结果区域：
1. 点击**"显示调试信息"**按钮
2. 查看详细的生成过程和状态

### 3. 调试信息说明

#### ✅ 正常流程

```
🚀 开始生成水印...
📱 环境: APP
👤 姓名: 张三
📅 时间: 2024-12-28 14:30:00
🖼️  图片: 已选择
✅ QRCode 库已导入

🔄 开始生成二维码...
✅ 二维码文本生成成功
📏 文本长度: 156
✅ QRCode 库已加载
🔄 调用 QRCode.create()...
✅ QRCode.create() 成功
📊 版本: 10
📊 模块数: 57x57
✅ 数据提取成功，模块总数: 3249
📐 二维码位置: (822, 1200)
📐 模块大小: 4.32px
✅ 白色背景绘制完成
✅ 二维码绘制完成，共1652个模块

✅ Canvas 转换成功
📁 临时文件: temp_xxx.jpg
```

#### ❌ 失败情况

如果二维码生成失败，会看到类似：

```
🚀 开始生成水印...
📱 环境: APP
👤 姓名: 张三
...
✅ QRCode 库已导入

🔄 开始生成二维码...
✅ 二维码文本生成成功
📏 文本长度: 156
✅ QRCode 库已加载
🔄 调用 QRCode.create()...
❌ QRCode.create() 失败: [具体错误信息]
❌ 错误: Error
❌ 详情: [错误详细描述]
📍 堆栈:
[错误堆栈信息]
```

---

## 常见问题排查

### 问题1: QRCode 库未导入

**现象：**
```
❌ QRCode 库未导入
```

**原因：**
- `qrcode` npm 包未正确安装
- 打包时未包含该依赖

**解决：**
```bash
npm install qrcode
# 重新打包
```

---

### 问题2: QRCode.create() 失败

**现象：**
```
🔄 调用 QRCode.create()...
❌ QRCode.create() 失败: ...
```

**可能原因：**

1. **二维码文本过长**
   - 当前文本约 150-180 字符
   - 如果超过二维码容量限制会失败
   - 解决：调整容错等级或减少数据

2. **qrcode 库在 APP 端不兼容**
   - `qrcode` 库主要为浏览器环境设计
   - 某些 API 在 APP 端可能不可用
   - 解决：使用专为 uniapp 设计的二维码库

3. **内存不足**
   - 生成大尺寸二维码需要较多内存
   - 解决：减小二维码尺寸或优化内存使用

---

### 问题3: 模块数为 0

**现象：**
```
✅ QRCode.create() 成功
📊 版本: 10
📊 模块数: 57x57
✅ 数据提取成功，模块总数: 3249
...
✅ 二维码绘制完成，共0个模块  ← 注意这里
```

**原因：**
- `modules.data` 数组全为 false
- 二维码数据生成异常

**解决：**
- 检查 `qrcode` 库版本
- 尝试其他二维码库

---

### 问题4: Canvas 转换失败

**现象：**
调试信息在二维码绘制后就结束了，没有"Canvas 转换成功"

**原因：**
- Canvas 尺寸过大
- 设备内存不足
- 权限问题

**解决：**
- 减小图片尺寸（当前固定 1080px 宽）
- 检查 manifest.json 权限配置
- 清理设备存储空间

---

## 备选方案

如果 `qrcode` 库在 APP 端始终无法工作，可以考虑：

### 方案 A: 使用专用库

使用专为 uniapp 设计的二维码库：

```bash
npm install uqrcodejs
```

```javascript
import uQRCode from 'uqrcodejs'

const qr = new uQRCode()
qr.data = qrCodeText
qr.size = 258
qr.make()
const modules = qr.modules
// 使用 modules 绘制到 canvas
```

### 方案 B: 后端生成

1. 将二维码文本发送到后端
2. 后端使用成熟的二维码库生成图片
3. 返回 Base64 或图片 URL
4. 前端使用 `ctx.drawImage()` 绘制

优点：
- 兼容性最好
- 不受客户端环境限制
- 可以统一管理和监控

### 方案 C: 使用 Canvas 2D API

Uniapp 新版支持 Canvas 2D API，兼容性更好：

```javascript
const query = uni.createSelectorQuery()
query.select('#myCanvas')
  .fields({ node: true, size: true })
  .exec((res) => {
    const canvas = res[0].node
    const ctx = canvas.getContext('2d')
    // 使用标准 Canvas 2D API
  })
```

---

## 测试建议

### 1. 分步测试

1. **测试定位图标**
   - 临时注释掉二维码生成代码
   - 只生成带定位图标的水印
   - 确认基础 Canvas 功能正常

2. **测试简单二维码**
   - 使用短文本（如 "test"）
   - 确认 `QRCode.create()` 是否可用

3. **测试完整流程**
   - 使用真实数据
   - 查看调试信息定位问题

### 2. 设备测试

在不同设备上测试：
- 不同品牌（小米、华为、OPPO 等）
- 不同 Android 版本
- 不同内存配置

记录哪些设备成功，哪些失败。

### 3. 性能监控

如果设备性能较低：
- 减小图片尺寸（从 1080px 改为 720px）
- 减小二维码尺寸（从 258px 改为 200px）
- 降低图片质量（从 0.9 改为 0.8）

---

## 上报问题

如果问题仍未解决，请提供以下信息：

1. **调试信息截图**
   - 点击"显示调试信息"
   - 截图完整的调试信息

2. **设备信息**
   - 手机品牌和型号
   - Android 版本
   - 可用内存

3. **操作步骤**
   - 使用的姓名
   - 选择的图片大小
   - 具体操作流程

4. **生成结果**
   - 右下角是否显示"二维码失败"的红色文字
   - 截图生成的水印图片

---

## 快速诊断

### 检查清单

- [ ] `package.json` 中有 `qrcode` 依赖
- [ ] 调试信息显示"QRCode 库已导入"
- [ ] 调试信息显示"QRCode.create() 成功"
- [ ] 模块数大于 0（通常 3000+）
- [ ] 绘制模块数大于 0（通常 1500+）
- [ ] 出现"Canvas 转换成功"

如果以上都打勾，但图片上看不到二维码：
- 可能是绘制位置问题
- 可能是颜色问题（白色背景+白色二维码）
- 可能是被其他元素覆盖

---

## 更新日志

**2024-12-28**
- ✅ 添加可视化调试信息功能
- ✅ 优化二维码生成错误处理
- ✅ 在界面上显示详细的生成过程
- ✅ 添加错误提示文字显示在二维码位置
- ✅ 修复定位图标透明度问题（改用实心图标）

---

## 联系支持

如需进一步帮助，请准备好：
1. 调试信息完整截图
2. 设备详细信息
3. 生成结果截图

这样可以更快定位和解决问题。

